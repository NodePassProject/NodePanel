
# NodePass 实例连接拓扑图

## 简介

NodePass 实例连接拓扑图是 NodePass 管理器中的一个核心功能模块，旨在提供一个图形化、可交互的界面，用于设计、可视化、配置和批量创建 NodePass 实例及其连接关系。通过此功能，用户可以直观地规划复杂的网络隧道和转发链路，并一键将其部署到已配置的 NodePass 主控服务上。

**主要优势:**
- **直观设计**: 通过拖拽方式在画布上构建网络拓扑。
- **批量操作**: 一次性提交整个拓扑图，在相应主控上批量创建所需实例。
- **清晰概览**: 清晰展示实例间的连接关系、主控归属和关键配置。
- **配置联动**: 自动同步和更新关联节点的属性，减少手动配置错误。
- **现有实例可视化**: 可加载已配置主控下的现有实例，并在画布上展示其连接关系。

## 页面主要组件

拓扑图页面由以下几个关键部分组成：

### 1. 控制栏 (TopologyControlBar)
位于页面顶部，提供对整个画布和拓扑操作的全局控制。
- **自适应视图**: 调整画布缩放级别，使所有节点都可见。
- **格式化布局**: 使用 ELK.js 算法自动排列画布上的节点和连接线，以优化可读性和美观性。若 ELK 失败，则回退到基本的分层布局。
- **刷新数据**: 重新从所有已配置的 NodePass 主控加载最新的实例列表。这会更新“已配置主控”面板中的实例和隧道计数。
- **提交拓扑**: 分析当前画布上的拓扑结构，生成待创建的 NodePass 实例配置，并在确认后批量提交到相应的主控进行创建。
- **清空画布**: 删除画布上所有的节点和连接线（会弹出确认对话框）。
- **数据刷新时间**: 显示“已配置主控”面板数据最后一次成功刷新的时间。

### 2. 画布区域 (React Flow Canvas)
页面的核心交互区域，用户在此构建和修改拓扑图。
- **节点 (Node)**: 代表 NodePass 主控、服务端实例、客户端实例或落地目标。
- **连接线/链路 (Edge)**: 代表实例间的连接关系。
- **交互**: 支持节点的拖拽、连接线的创建与删除、画布的平移和缩放。
- **背景**: 网格背景，便于对齐和查看。
- **MiniMap**: 右下角提供一个小型的画布概览图，方便在大型拓扑中导航。

### 3. 可拖拽面板 (DraggablePanels)
位于画布左侧，包含两个可拖拽元素的面板。

- **已配置主控 (Masters Panel)**
    - 列出所有通过“设置”菜单添加的 NodePass 主控连接。
    - 每个主控条目显示其名称、图标 (黄色齿轮)、该主控下已存在的实例数量和大致的隧道数量。
    - **拖拽操作**: 将主控条目拖拽到画布上，可以创建一个代表该主控的“主控节点”。
    - **下拉菜单**: 每个主控条目右侧有下拉箭头，提供以下操作：
        - **渲染完整拓扑**: 清空当前画布，然后加载并显示此主控下所有现有实例及其推断的连接关系。
        - **渲染实例链路**: (如果主控下有实例) 列出该主控下的所有实例，选择一个实例后，画布将清空并显示与该选定实例直接相关的上游和下游节点及连接。

- **组件面板 (Components Panel)**
    - 列出可用于构建拓扑的 NodePass 组件类型。
    - **服务端 (Server)**: 代表 NodePass 出口(s)实例。图标为蓝色服务器。
    - **客户端 (Client)**: 代表 NodePass 入口(c)实例。图标为水鸭色智能手机。
    - **落地 (Landing)**: 代表最终的流量目标 (如某个应用的 IP 和端口)。图标为紫色地球。
    - **用户源 (User Source)**: (暂未启用) 设计上用于表示用户流量的起点。图标为绿色用户。
    - **拖拽操作**: 将组件类型从面板拖拽到画布上，可以创建一个对应类型的新节点。

### 4. 属性显示面板 (PropertiesDisplayPanel)
位于画布左侧，可拖拽面板下方。
- 当在画布上选中一个节点时，此面板会显示该节点的详细属性信息（如ID、类型、标签、隧道地址、管理主控等）。
- 若未选择任何节点，则显示提示信息“点击节点查看属性”或“未选择节点”。
- 提供操作提示，如“右键点击节点可编辑或删除”。
- 节点属性的实际编辑通过右键节点的上下文菜单触发，并在弹出的对话框中进行。

## 核心功能与交互

### 节点操作

- **添加节点**:
    - **从组件面板拖拽**:
        - 拖拽“服务端”、“客户端”或“落地”到画布，创建对应类型的新节点。
        - **管理主控分配**: 当拖拽服务端或客户端节点时：
            - 如果画布上没有“服务焦点”角色的主控节点，且系统中配置了多个主控，会弹出“选择管理主控”对话框 (SelectManagingControllerDialog)，要求用户为新节点指定一个管理主控。
            - 如果画布上已有“服务焦点”角色的主控，或通过对话框选定了主控，新节点将自动关联此主控（`managingApiId`, `managingApiName` 属性被设置）。
            - 新节点会从其管理主控继承默认配置，如日志级别 (`logLevel`) 和 TLS 模式 (`tlsMode`，仅服务端)。
        - **隧道端口自动分配**: 对于服务端节点或充当服务端的客户焦点主控节点，画布会尝试为其分配一个在其声明的监听主机上不与画布上其他节点冲突的隧道端口 (基于 `getNextAvailableTunnelPortOnCanvas` 逻辑)。
    - **从主控面板拖拽**:
        - 拖拽一个已配置的主控到画布，创建一个“主控节点”。
        - **角色自动分配**:
            - 画布上第一个主控节点默认为“服务焦点”(Server Role)。
            - 后续添加的主控节点默认为“客户焦点”(Client Role)。
        - **配置继承**: 主控节点的数据会从其原始 `NamedApiConfig` 中填充，如 API 名称、ID、默认日志级别和 TLS 模式。客户焦点主控还会获得默认的隧道和转发地址。

- **编辑节点属性**:
    - **触发**: 右键点击画布上的节点，从上下文菜单选择“编辑属性”。这会打开一个属性编辑对话框 (EditPropertiesDialog - 内部实现，通过 state 控制)。
    - **可编辑字段**: 根据节点类型不同而异。
        - **通用**: 标签 (Label)。
        - **主控 (客户焦点)**: 隧道地址, 转发地址, 日志级别。
        - **服务端**: 隧道监听地址, 流量转发地址, 日志级别, TLS 模式 (0:无, 1:自签, 2:自定义), 证书路径 (TLS 2), 密钥路径 (TLS 2)。
        - **客户端**: 服务端隧道地址, 本地转发地址, 日志级别。
        - **落地**: IP 地址, 端口。
    - **属性联动**:
        - 修改服务端节点的隧道地址，会自动更新连接到它的客户端节点的隧道地址。
        - 修改客户端节点的目标地址，如果它连接到一个落地节点，会自动更新落地节点的 IP/端口；反之亦然。
    - **隧道端口冲突检测**: 编辑服务端或客户焦点主控的隧道地址时，会检查端口冲突并自动递增以寻找可用端口。

- **删除节点**:
    - **触发**: 右键点击节点，选择“删除节点”。会弹出确认对话框 (DeleteNodeDialog)。
    - **效果**: 节点及其所有相关的连接线都将从画布上移除。

- **展开/折叠节点**:
    - **触发**: 单击画布上的节点。
    - **效果**: 切换节点的详细信息显示状态 (`isExpanded` 属性)。展开时，节点高度增加，并显示更多如日志级别、TLS模式、管理主控等具体配置信息。用户源节点不可展开。

- **主控节点角色 (Controller Node Role)**:
    - 主控节点在画布上可以扮演不同角色，影响其行为和连接方式。
    - **服务焦点 (Server Role)**:
        - 通常作为一组相关实例的中心管理单元。
        - 从此主控节点引出的连接线，会将下游的服务端/客户端实例的管理主控设置为此服务焦点主控。
        - 负责创建与其直接或间接关联的实例。
    - **客户焦点 (Client Role)**:
        - 代表一个远程的 NodePass 主控或一个需要通过隧道连接到服务焦点主控的场景。
        - 自身具有隧道地址（连接到哪个服务焦点主控的隧道）和转发地址（将流量转发到此客户焦点主控管理的哪个本地服务）。
        - 实例创建时，会在客户焦点主控上创建一个 `client` 类型实例，并在其连接的服务焦点主控上创建一个匹配的 `server` 类型实例。
    - **更改角色**: 右键点击主控节点，在上下文菜单中选择“更改角色”，然后选择“服务焦点”、“客户焦点”或“通用”。角色更改会影响节点的显示、属性和连接行为。

### 连接线 (链路) 操作

- **创建连接**:
    - **触发**: 从一个节点的输出句柄 (通常在右侧) 拖拽连接线到另一个节点的输入句柄 (通常在左侧)。
    - **有效性检查 (`isValidConnection`)**:
        - **类型兼容性**:
            - 主控 (服务焦点) -> 服务端 / 客户端 / 主控 (客户焦点)
            - 用户源 -> 客户端 / 主控 (客户焦点)
            - 服务端 -> 客户端 / 落地
            - 客户端 -> 服务端 / 客户端 (用于串联) / 落地
            - 主控 (客户焦点) -> 服务端 / 客户端 / 落地 (当其充当一个转发源时)
        - **句柄限制**:
            - 大多数节点的输入句柄只允许一个传入连接 (例如，一个客户端只能连接到一个服务端隧道)。
            - 大多数节点的输出句柄也只允许一个传出连接 (确保链路的单一流向)。
        - 连接失败会显示 Toast 提示。
    - **属性自动同步**:
        - **服务端 -> 客户端**: 客户端的“服务端隧道地址”会自动设置为服务端的“隧道监听地址”。
        - **客户端/服务端 -> 落地**: 如果客户端或服务端连接到一个落地节点，其“目标转发地址”会与落地节点的“IP:端口”同步。反之，修改落地节点的IP/端口也会更新上游连接节点的“目标转发地址”。
        - **主控 -> 实例**: 当服务端或客户端连接到一个主控节点 (服务焦点) 时，该实例的“管理主控”属性会自动设置为此主控。实例的日志级别和TLS模式也会根据主控的默认设置进行初始化。
    - **样式**: 连接线的颜色和箭头样式会根据源节点和目标节点的类型动态调整，以区分不同类型的连接。

- **删除连接**:
    - **触发**: 右键点击连接线，从上下文菜单选择“删除链路”。

### 画布与布局

- **自适应视图**: 点击控制栏的“自适应”按钮，画布会自动缩放和平移，以确保所有节点都完整显示在可视区域内。
- **格式化布局**: 点击控制栏的“格式化”按钮，系统会使用 ELK.js (一个强大的图布局库) 的分层算法重新排列画布上的所有节点和连接线，以生成一个更整洁、更易于理解的布局。如果 ELK.js 处理失败，则会回退到一个简单的基于节点类型的分层布局。
- **数据刷新**: 点击控制栏的“刷新数据”按钮，会重新从所有已配置的主控获取最新的实例列表。这些数据主要用于更新“已配置主控”面板中各个主控的实例和隧道计数。
- **清空画布**: 点击控制栏的“清空画布”按钮，在确认后，会移除画布上所有的节点和连接线。
- **高亮显示链路链**: 当用户在画布上单击一个节点时，该节点及其直接的上游和下游相关节点与连接线会被高亮显示 (通常为绿色边框或加粗连接线)，帮助用户聚焦于特定链路。再次点击画布空白处或选择其他节点会取消高亮。

### 拓扑提交 (SubmitTopologyDialog)

- **触发**: 点击控制栏的“提交拓扑”按钮。
- **分析与生成URL**:
    - 系统会遍历画布上的所有节点和连接线。
    - **对于服务端和客户端节点**: 使用 `buildNodePassUrlFromNode` 函数，根据节点的类型、隧道地址、目标地址、日志级别、TLS模式等属性，构建标准的 NodePass 实例创建 URL。
        - 如果节点连接到一个“落地”节点，则“落地”节点的 IP 和端口将作为该实例 URL 中的目标地址部分。
    - **对于主控节点间的连接 (客户焦点 <-> 服务焦点)**:
        - 在“客户焦点”主控上，会生成一个 `client` 类型的实例 URL，其隧道地址指向“服务焦点”主控提供的隧道服务，其目标地址是“客户焦点”主控配置的转发目标。
        - 在“服务焦点”主控上，会生成一个匹配的 `server` 类型的实例 URL，其监听地址对应“客户焦点”连接的隧道，其目标地址通常是 `0.0.0.0` 加上为“客户焦点”场景分配的内部端口。
- **预览与确认**:
    - 生成的待创建实例 URL 会在“提交拓扑”对话框 (SubmitTopologyDialog) 中按其所属的管理主控进行分组显示。
    - 用户可以预览将要在哪个主控上创建哪些实例。
- **批量创建**:
    - 用户确认提交后，系统会并发地向各个主控的 API 发送创建实例的请求。
    - **状态反馈**: 画布上的相应节点（或代表主控间隧道的源/目标主控节点）会显示提交状态：
        - “处理中...”: 表示正在向 API 发送请求。
        - “已提交 (ID: xxx)”: 表示实例创建成功，并显示部分实例ID。
        - “提交失败”: 表示实例创建请求失败。
        - “主控配置错误”: 表示该主控的 API 信息无效，无法提交。
    - Toast 通知会汇总本次提交的成功和失败数量。

### 加载现有拓扑/实例

此功能允许用户将已存在于 NodePass 主控中的实例加载到画布上进行可视化和分析。

- **从“已配置主控”面板触发**:
    - **渲染完整拓扑**:
        - 在主控条目的下拉菜单中选择“渲染完整拓扑”。
        - 画布会被清空。
        - 系统会获取该主控下的所有实例 (`server` 和 `client` 类型)。
        - 为每个实例创建一个对应的画布节点，并尝试根据实例的 URL (特别是客户端的隧道地址和目标地址，以及服务端的监听地址) 来推断和创建它们之间的连接线。
        - 最终使用 ELK.js 进行自动布局。
    - **渲染实例链路**:
        - 在主控条目的下拉菜单中选择一个具体实例。
        - 画布会被清空。
        - 系统会创建代表此选定实例的节点。
        - 然后，它会查找与此实例直接关联的上游（例如，管理此实例的主控，或此客户端连接的服务端）和下游（例如，连接到此服务端的客户端，或此客户端连接的落地目标）节点，并将它们也添加到画布上，并创建相应的连接线。
        - 同样使用 ELK.js 进行自动布局。
- **URL 解析**: 在加载现有实例时，系统使用 `parseNodePassUrlForTopology` 函数来解析实例的 URL，提取出类型、隧道地址、目标地址、日志级别、TLS模式等信息，用于正确配置画布上的节点数据。

## 节点类型详解

### 1. 主控节点 (Controller Node)
- **图标**: <img src="https://raw.githubusercontent.com/lucide-icons/lucide/master/icons/cog.svg" width="16" height="16" alt="Cog Icon" /> (黄色)
- **描述**: 代表一个已配置的 NodePass 主控服务。它是画布上其他实例节点的管理单元。
- **画布角色**:
    - **服务焦点 (Server Role)**:
        - 通常是画布上第一个被添加的主控，或被显式设置的角色。
        - 作为其管理的实例（直接或间接连接到它的服务端/客户端节点）的 API 操作目标。
        - 当一个实例（如服务端节点）从它拖出或连接到它时，该实例的“管理主控”会被设为这个服务焦点主控。
        - 属性中包含该主控的 API 名称、ID，以及其为下属实例提供的默认日志级别和默认TLS模式。
    - **客户焦点 (Client Role)**:
        - 当画布上已存在服务焦点主控后，再拖入的其他主控默认为此角色，或可手动设置。
        - 代表一个远程 NodePass 主控，它需要通过一个隧道连接到当前画布中的某个“服务焦点”主控。
        - 具有特定的属性：
            - **隧道地址**: 此客户焦点主控上的客户端实例将连接到哪个“服务焦点”主控的隧道端点 (格式 `host:port`)。
            - **转发地址**: 客户焦点主控内部的某个服务地址 (格式 `host:port`)，通过上述隧道暴露给服务焦点主控一侧。
            - **日志级别**: 此客户焦点主控上创建的客户端实例的日志级别。
        - 提交拓扑时，会在客户焦点主控上创建一个 `client` 实例，并在其连接的服务焦点主控上创建一个匹配的 `server` 实例，形成主控间的隧道。
- **交互**: 可从“已配置主控”面板拖拽添加。右键可编辑名称（同步于标签）、更改角色。单击可展开/折叠显示详细信息。

### 2. 服务端节点 (Server Node)
- **图标**: <img src="https://raw.githubusercontent.com/lucide-icons/lucide/master/icons/server.svg" width="16" height="16" alt="Server Icon" /> (主题主色，例如蓝色)
- **描述**: 代表一个 NodePass 出口(s) 实例。它监听一个隧道地址，并将接收到的流量转发到其配置的目标地址。
- **属性**:
    - **标签**: 用户自定义的节点名称。
    - **隧道监听地址**: 出口(s)实例监听来自入口(c)的控制连接的地址 (格式 `host:port`，主机通常为 `0.0.0.0` 或 `[::]`)。
    - **流量转发地址**: 出口(s)实例将解包后的业务流量转发到的最终目标地址 (格式 `host:port`)。
    - **日志级别**: `master`, `debug`, `info`, `warn`, `error`, `event`。
    - **TLS 模式**: `master` (主控默认), `0` (无TLS), `1` (自签名证书), `2` (自定义证书)。
    - **证书路径 (crtPath)**: TLS 模式为 `2` 时指定。
    - **密钥路径 (keyPath)**: TLS 模式为 `2` 时指定。
    - **管理主控**: (自动分配) 创建此实例的主控名称。
- **交互**: 可从组件面板拖拽添加。右键可编辑属性、删除。单击可展开/折叠。

### 3. 客户端节点 (Client Node)
- **图标**: <img src="https://raw.githubusercontent.com/lucide-icons/lucide/master/icons/smartphone.svg" width="16" height="16" alt="Client Icon" /> (主题辅色，例如水鸭色)
- **描述**: 代表一个 NodePass 入口(c) 实例。它连接到一个出口(s)实例的隧道，并将本地服务的流量通过隧道转发出去。
- **属性**:
    - **标签**: 用户自定义的节点名称。
    - **服务端隧道地址**: 入口(c)实例连接的出口(s)实例的隧道监听地址 (格式 `host:port`)。
    - **本地转发地址**: 入口(c)实例在本地监听的地址 (格式 `host:port`，主机通常为 `127.0.0.1` 或 `[::]`)，本地应用连接此地址以通过隧道发送数据。
    - **日志级别**: `master`, `debug`, `info`, `warn`, `error`, `event`。
    - **管理主控**: (自动分配) 创建此实例的主控名称。
- **交互**: 可从组件面板拖拽添加。右键可编辑属性、删除。单击可展开/折叠。

### 4. 落地节点 (Landing Node)
- **图标**: <img src="https://raw.githubusercontent.com/lucide-icons/lucide/master/icons/globe.svg" width="16" height="16" alt="Landing Icon" /> (紫色)
- **描述**: 代表一个网络链路的最终实际目标，通常是一个具体的服务或设备的 IP 地址和端口。
- **属性**:
    - **标签**: 用户自定义的节点名称。
    - **IP 地址**: 目标的 IP 地址。
    - **端口**: 目标的服务端口。
    - **上游主控**: (自动分配或显示) 与此落地目标相关的上游 NodePass 主控的名称（即管理连接到此落地节点的客户端/服务端实例的主控）。
- **交互**: 可从组件面板拖拽添加。右键可编辑属性、删除。单击可展开/折叠。连接到一个客户端或服务端节点时，其 IP 和端口会自动成为该客户端/服务端的目标转发地址。

### 5. 用户源节点 (User Node)
- **图标**: <img src="https://raw.githubusercontent.com/lucide-icons/lucide/master/icons/user-circle-2.svg" width="16" height="16" alt="User Icon" /> (绿色)
- **描述**: (暂未启用) 设计上用于表示用户或外部流量的起点，可以连接到客户端节点或客户焦点主控。
- **当前状态**: 此节点类型目前无法从组件面板拖拽到画布上，其功能可能在未来版本中完善。

## 视觉与交互效果

- **动态样式**: 节点边框颜色、图标颜色以及连接线的颜色会根据节点类型、选中状态、链路高亮状态以及提交状态（成功/失败）动态变化，提供丰富的视觉反馈。
- **链路高亮**: 单击一个节点会高亮显示其完整的上游和下游链路（节点边框变粗，连接线变为特定颜色并可能显示动画），方便追踪数据流向。
- **拖拽反馈**: 拖拽节点和连接线时，会有相应的视觉提示。
- **MiniMap**: 画布右下角的 MiniMap 提供了整个拓扑的缩略图，便于在复杂拓扑中快速定位和导航。
- **展开/折叠动画**: 节点展开和折叠时伴有平滑的动画效果。
- **Toast 通知**: 对于创建连接、编辑属性、删除元素、提交拓扑等关键操作，系统会通过屏幕右上角的 Toast 通知用户操作结果（成功、失败、警告）。
- **加载状态**: 在执行耗时操作（如刷新数据、格式化布局、提交拓扑）时，相关按钮会显示加载动画 (旋转的 `Loader2` 图标)，并禁用按钮，防止重复操作。
- **提交状态显示**: 提交拓扑后，画布上的相关节点下方会显示本次创建操作的状态，如“已提交 (ID: xxx)”、“提交失败”或“主控配置错误”。

## 工作流程示例

1.  **添加主控**: 如果系统中没有配置主控，首先通过右上角设置菜单添加一个或多个 NodePass 主控连接。
2.  **拖入主控节点**: 从“已配置主控”面板将一个主控拖拽到画布上。它将成为“服务焦点”。
3.  **拖入实例节点**: 从“组件面板”拖拽一个“服务端”节点到画布上。
4.  **连接节点**: 从主控节点的输出句柄拖拽一条连接线到服务端节点的输入句柄。此时，服务端节点的“管理主控”属性会自动设为该主控，并继承默认配置。
5.  **配置服务端**: 右键点击服务端节点，选择“编辑属性”，设置其“隧道监听地址”（如 `0.0.0.0:10001`）和“流量转发地址”（如 `192.168.1.100:80`）。
6.  **拖入客户端节点**: 从“组件面板”拖拽一个“客户端”节点到画布上。
7.  **连接客户端到服务端**: 从服务端节点的输出句柄拖拽连接线到客户端节点的输入句柄。客户端的“服务端隧道地址”会自动填充为服务端的监听地址。
8.  **配置客户端**: 右键点击客户端节点，编辑其“本地转发地址”（如 `127.0.0.1:8080`）。
9.  **(可选) 添加落地节点**: 拖入一个“落地”节点，将其连接到客户端或服务端的输出。节点的 IP 和端口会自动同步到上游实例的目标地址。
10. **(可选) 格式化布局**: 点击控制栏的“格式化布局”按钮，美化画布。
11. **提交拓扑**: 点击控制栏的“提交拓扑”按钮。在弹出的对话框中确认无误后，点击“确认提交”。系统将向主控发送创建实例的请求。
12. **查看状态**: 观察画布上节点的提交状态以及 Toast 通知。

## 提示与已知问题

- **ELK 布局**: 虽然 ELK.js 布局效果通常很好，但在某些复杂或特殊拓扑下，可能仍需用户手动微调节点位置以达到最佳可读性。
- **主控配置**: 确保所有主控的 API 地址、令牌和（如果需要）API 前缀路径都配置正确且可访问。错误的配置会导致实例加载和创建失败。
- **网络可达性**: 在设计跨主控的隧道或连接到外部服务时，请确保相关的网络端口已开放，并且主控之间、主控与目标服务之间具有网络可达性。
- **唯一隧道端口**: 在同一主控的同一监听主机（如`0.0.0.0`）上，每个服务端（或充当服务端的客户焦点主控）的隧道监听端口必须是唯一的。画布在添加或编辑时会尝试自动处理冲突，但最终提交到 NodePass 服务时仍需遵守此规则。
- **浏览器本地存储**: 主控连接配置信息存储在浏览器的 localStorage 中。清除浏览器数据可能会导致配置丢失（除非已导出备份）。
- **用户源节点**: “用户源”节点类型目前在面板中被禁用，其代表的流量发起方概念尚未完全集成到画布交互中。

---

希望这份文档能帮助您更好地理解和使用 NodePass 实例连接拓扑图功能！
